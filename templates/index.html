<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Thermostat with Video Stream</title>
    <script>
        let currentTargetTemp;
        let currentSetTemp;
        let tempChangeTimeout;
        let currentMode;

        // Function to initialize the desired temperature
        function initializeDesiredTemperature() {
            fetch("/set_temperature")
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    currentSetTemp = data.desired_temperature;
                    currentTargetTemp = currentSetTemp;
                    document.getElementById("set-temperature").innerText = currentSetTemp + "°F";
                    document.getElementById("desired-temperature").value = currentSetTemp;
                });
        }

        // Function to update the time since last action
        function updateTimeSinceLastAction() {
            fetch("/time_since_last_action")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("time-since-last-action").innerText = data.time_since_last_action + " seconds";
                });
        }

        // Function to update the current mode
        function updateCurrentMode() {
            fetch("/current_mode")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("current-mode").innerText = data.current_mode;
                    currentMode = data.current_mode;
                });
        }

        // Function to update the desired temperature
        function updateDesiredTemperature() {
            fetch("/set_temperature")
                .then(response => response.json())
                .then(data => {
                    currentSetTemp = data.desired_temperature;
                    document.getElementById("set-temperature").innerText = currentSetTemp + "°F";
                });
        }

        // Function to update heat and cool temperature settings
        function updateTemperatureSettings() {
            fetch("/temperature_settings")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("heat-temperature").innerText = data.current_heat_temp + "°F";
                    document.getElementById("cool-temperature").innerText = data.current_cool_temp + "°F";
                });
        }

        // Function to adjust the temperature
        function adjustTemperature(change) {
            currentTargetTemp += change;
            document.getElementById("desired-temperature").value = currentTargetTemp;

            if (tempChangeTimeout) {
                clearTimeout(tempChangeTimeout);
            }

            tempChangeTimeout = setTimeout(() => {
                sendTemperatureUpdate();
            }, 10000);
        }

        // Function to send the temperature update to the server
        function sendTemperatureUpdate() {
            console.log("Sending temperature update to server");
            console.log("Current Set Temp: " + currentSetTemp);
            console.log("Current Target Temp: " + currentTargetTemp);
            if (currentTargetTemp !== currentSetTemp) {
                fetch("/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: `set_temperature=true&temperature=${currentTargetTemp}`
                });
            }
        }
        
        // Function to check mode change
        function checkModeChange() {
            const selectedMode = document.querySelector('input[name="mode"]:checked').value;
            if (selectedMode !== currentMode) {
                console.log("Mode changed to: " + selectedMode);
                fetch("/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: `mode=${selectedMode}`
                });
            }
        }

        // Function to activate the light
        function activateLight() {
            console.log("Activating light");
            fetch("/activate_light", {
                method: "POST"
            });
        }

        // Initialize the desired temperature and update the page every second
        window.onload = function() {
            initializeDesiredTemperature();
            setInterval(updateTimeSinceLastAction, 1000);
            setInterval(updateCurrentMode, 1000);
            setInterval(updateDesiredTemperature, 1000);
            setInterval(updateTemperatureSettings, 1000); // Update heat and cool settings
            setInterval(checkModeChange, 10000); // Check for mode changes
            //setInterval(activateLight, 1800000); // Activate light every 30 minutes

            // Reload the video feed every 3 seconds
            setInterval(() => {
                const video = document.getElementById('video');
                video.src = "{{ url_for('video_feed') }}" + '?t=' + new Date().getTime();
            }, 3000);
        };
    </script>
</head>
<body>
    <h1>Smart Thermostat Control</h1>
    <form method="POST">
        <label for="temperature">Desired Temperature:</label>
        <input type="number" id="desired-temperature" name="temperature" value="" min="50" max="90" readonly>
        <button type="button" onclick="adjustTemperature(1)">Increase</button>
        <button type="button" onclick="adjustTemperature(-1)">Decrease</button>

        <div>
            <label>Mode:</label>
            {% for mode in mode_options %}
            <label>
                <input type="radio" name="mode" value="{{ mode.lower() }}" {% if current_mode == loop.index0 %}checked{% endif %}>
                {{ mode }}
            </label>
            {% endfor %}
        </div>

        <button type="submit" name="light">Light</button>

        <!-- Button to toggle manual mode -->
        <button type="submit" name="manual_override">
            {{ 'Disable' if manual_override else 'Enable' }} Manual Mode
        </button>
    </form>
    <p>Heat Temperature Setting: <span id="heat-temperature">{{ current_heat_temp }}°F</span></p>
    <p>Cool Temperature Setting: <span id="cool-temperature">{{ current_cool_temp }}°F</span></p>
    <p>Current Set Temperature: <span id="set-temperature"></span></p>
    <p>Current Mode: <span id="current-mode">{{ mode_options[current_mode] }}</span></p>
    <p>Manual Override: {{ 'Active' if manual_override else 'Inactive' }}</p>
    <p>Time Since Last Action: <span id="time-since-last-action">{{ time_since_last_action | round(1) }} seconds</span></p>

    <h2>Video Stream</h2>
    <img id="video" src="{{ url_for('video_feed') }}" style="width:640px; height:480px;">
</body>
</html>

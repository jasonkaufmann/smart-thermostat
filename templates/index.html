<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Thermostat</title>
    <script>
        let currentTargetHeatTemp = {{ current_heat_temp }};
        let currentTargetCoolTemp = {{ current_cool_temp }};
        let lastSentHeatTemp = currentTargetHeatTemp;
        let lastSentCoolTemp = currentTargetCoolTemp;
        let tempChangeTimeout;

        // Function to update the time since last action
        function updateTimeSinceLastAction() {
            fetch("/time_since_last_action")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("time-since-last-action").innerText = data.time_since_last_action + " seconds";
                });
        }

        // Function to update the ambient temperature
        function updateAmbientTemperature() {
            fetch("/ambient_temperature")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("ambient-temperature").innerText = data.ambient_temperature.toFixed(1) + "째F";
                });
        }

        // Function to update the current mode
        function updateCurrentMode() {
            fetch("/current_mode")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("current-mode").innerText = data.current_mode;
                });
        }

        // Function to update the desired temperatures
        function updateDesiredTemperatures() {
            fetch("/desired_temperatures")
                .then(response => response.json())
                .then(data => {
                    currentTargetHeatTemp = data.desired_heat_temperature;
                    currentTargetCoolTemp = data.desired_cool_temperature;
                    document.getElementById("heat-temperature").value = currentTargetHeatTemp;
                    document.getElementById("cool-temperature").value = currentTargetCoolTemp;
                });
        }

        // Function to adjust the temperature
        function adjustTemperature(change, type) {
            if (type === 'heat') {
                currentTargetHeatTemp += change;
                document.getElementById("heat-temperature").value = currentTargetHeatTemp;
            } else if (type === 'cool') {
                currentTargetCoolTemp += change;
                document.getElementById("cool-temperature").value = currentTargetCoolTemp;
            }

            if (tempChangeTimeout) {
                clearTimeout(tempChangeTimeout);
            }

            tempChangeTimeout = setTimeout(() => {
                sendTemperatureUpdate();
            }, 10000);
        }

        // Function to send the temperature update to the server
        function sendTemperatureUpdate() {
            let body = `set_temperature=true&heat_temperature=${currentTargetHeatTemp}&cool_temperature=${currentTargetCoolTemp}`;

            if (currentTargetHeatTemp !== lastSentHeatTemp || currentTargetCoolTemp !== lastSentCoolTemp) {
                fetch("/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: body
                }).then(response => {
                    if (response.ok) {
                        lastSentHeatTemp = currentTargetHeatTemp;
                        lastSentCoolTemp = currentTargetCoolTemp;
                    }
                });
            }
        }

        // Update the time, temperatures, and mode every second
        setInterval(updateTimeSinceLastAction, 1000);
        setInterval(updateAmbientTemperature, 1000);
        setInterval(updateCurrentMode, 1000);
        setInterval(updateDesiredTemperatures, 1000);
    </script>
</head>
<body>
    <h1>Smart Thermostat Control</h1>
    <form method="POST">
        <label for="heat-temperature">Desired Heat Temperature:</label>
        <input type="number" id="heat-temperature" name="heat-temperature" value="{{ current_heat_temp }}" min="60" max="90" readonly>
        <button type="button" onclick="adjustTemperature(1, 'heat')">Increase Heat</button>
        <button type="button" onclick="adjustTemperature(-1, 'heat')">Decrease Heat</button>

        <label for="cool-temperature">Desired Cool Temperature:</label>
        <input type="number" id="cool-temperature" name="cool-temperature" value="{{ current_cool_temp }}" min="60" max="90" readonly>
        <button type="button" onclick="adjustTemperature(1, 'cool')">Increase Cool</button>
        <button type="button" onclick="adjustTemperature(-1, 'cool')">Decrease Cool</button>

        <div>
            <label>Mode:</label>
            {% for mode in mode_options %}
            <label>
                <input type="radio" name="mode" value="{{ mode.lower() }}" {% if current_mode == loop.index0 %}checked{% endif %}>
                {{ mode }}
            </label>
            {% endfor %}
        </div>

        <button type="submit" name="light">Light</button>

        <!-- Button to toggle manual mode -->
        <button type="submit" name="manual_override">
            {{ 'Disable' if manual_override else 'Enable' }} Manual Mode
        </button>
    </form>
    <p>Current Heat Temperature: {{ current_heat_temp }}째F</p>
    <p>Current Cool Temperature: {{ current_cool_temp }}째F</p>
    <p>Ambient Temperature: <span id="ambient-temperature">{{ ambient_temp | round(1) }}째F</span></p>
    <p>Current Mode: <span id="current-mode">{{ mode_options[current_mode] }}</span></p>
    <p>Manual Override: {{ 'Active' if manual_override else 'Inactive' }}</p>
    <p>Time Since Last Action: <span id="time-since-last-action">{{ time_since_last_action | round(1) }} seconds</span></p>
</body>
</html>
